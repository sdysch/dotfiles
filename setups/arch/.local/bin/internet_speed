#!/bin/bash

# FIXME the calculated speeds are wrong

# Temp file to store previous counters
STATE_FILE="/tmp/internet_speed_state"

# Detect active interface automatically
IFACE=$(ip route get 8.8.8.8 2>/dev/null | awk '{print $5; exit}')
[ -z "$IFACE" ] && exit 0

# Read current RX/TX bytes
RX_NOW=$(cat /sys/class/net/$IFACE/statistics/rx_bytes)
TX_NOW=$(cat /sys/class/net/$IFACE/statistics/tx_bytes)

# Read previous counters
if [ -f "$STATE_FILE" ]; then
    read RX_PREV TX_PREV < "$STATE_FILE"
else
    RX_PREV=$RX_NOW
    TX_PREV=$TX_NOW
fi

# Save current counters for next run
echo "$RX_NOW $TX_NOW" > "$STATE_FILE"

# Calculate speeds (bytes per second)
RX_BPS=$((RX_NOW - RX_PREV))
TX_BPS=$((TX_NOW - TX_PREV))

# Convert to human-readable
human_readable() {
    local BYTES=$1
    if [ $BYTES -ge 1000000 ]; then
        echo "$((BYTES/1000000))MB/s"
    elif [ $BYTES -ge 1000 ]; then
        echo "$((BYTES/1000))KB/s"
    else
        echo "${BYTES}B/s"
    fi
}

RX_HR=$(human_readable $RX_BPS)
TX_HR=$(human_readable $TX_BPS)

# Color based on speed (brighter Nord theme)
color_for_speed() {
    local BYTES=$1
    if [ $BYTES -lt 50000 ]; then
        echo "#8FBCBB"  # cyan
    elif [ $BYTES -lt 200000 ]; then
        echo "#EBCB8B"  # yellow
    else
        echo "#D08770"  # orange/red
    fi
}

RX_COLOR=$(color_for_speed $RX_BPS)

# Output JSON for Waybar
echo "{\"text\":\"↓ $RX_HR ↑ $TX_HR\",\"color\":\"$RX_COLOR\"}"
