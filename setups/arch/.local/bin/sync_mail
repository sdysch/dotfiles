#!/usr/bin/env bash

CONFIG="$HOME/.config/isync/mbsyncrc"
LASTRUN="${XDG_CONFIG_HOME:-$HOME/.config}/mail/.mailsynclastrun"
MAILDIR="$HOME/.local/share/mail"

mkdir -p "$(dirname "$LASTRUN")"

# Run mbsync
mbsync -c "$CONFIG" -a >/dev/null 2>&1

# Find new mails since last run
NEW_MAIL_FILES=$(find "$MAILDIR" -type f -path "*/INBOX/new/*" 2>/dev/null)
NEW_COUNT=$(echo "$NEW_MAIL_FILES" | sed '/^\s*$/d' | wc -l)

# Print count of new mail
if [ "$NEW_COUNT" -gt 0 ]; then
	notify-send -u normal -i "mail-unread" "Mail Sync" "ðŸ“¬ $NEW_COUNT new mail(s)"
fi

# Iterate over new mail files
for MAILFILE in $NEW_MAIL_FILES; do
    FROM=$(awk '/^From: / {print; exit}' "$MAILFILE" | sed 's/^From: //' | tr -d '\n\t')
    SUBJECT=$(awk '/^Subject: / {print; exit}' "$MAILFILE" | sed 's/^Subject: //' | tr -d '\n\t')

    # echo "From: $FROM"
    # echo "Subject: $SUBJECT"

    # Notify each new mail
    if [ -n "$DISPLAY" ] && [ -n "$DBUS_SESSION_BUS_ADDRESS" ]; then
        notify-send -u normal -i "mail-unread" "ðŸ“¬ $FROM" "$SUBJECT"
    fi
done

# Update last run timestamp
touch "$LASTRUN"

# Ping waybar
command -v waybar >/dev/null && pkill -RTMIN+9 waybar
