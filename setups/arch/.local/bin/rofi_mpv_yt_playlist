#!/usr/bin/env bash
# Fully rofi-based YouTube playlist launcher

# Check for --audio-only
AUDIO_ONLY=0
for arg in "$@"; do
  if [ "$arg" = "--audio-only" ]; then
    AUDIO_ONLY=1
  fi
done

# 1️⃣ Ask for query
query=$(rofi -dmenu -p "Search playlist:")
[ -z "$query" ] && exit 0

# 2️⃣ Fetch top playlists and prepare options
# Format: Title (video count)|||URL
mapfile -t options < <(
  yt-dlp "ytsearch15:$query" --flat-playlist \
    --print "%(title)s (%(playlist_count)s videos)|||%(webpage_url)s"
)

# Exit if no results
[ "${#options[@]}" -eq 0 ] && exit 0

# 3️⃣ Show playlists in rofi menu
selection=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "Select playlist:")

[ -z "$selection" ] && exit 0

# 4️⃣ Extract URL from selection
url="${selection##*|||}"

# 5️⃣ Launch mpv
if [ "$AUDIO_ONLY" -eq 1 ]; then
  exec mpv --no-video "$url"
else
  exec mpv "$url"
fi
