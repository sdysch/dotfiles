#!/usr/bin/env bash

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}"
CACHE_FILE="$CACHE_DIR/weatherreport"
TIME_FILE="$CACHE_DIR/weatherreport.time"
CACHE_TTL=3600
LABELS=("Morning" "Noon" "Evening" "Night")
HOURS=(6 12 18 0)  # Approx hours for labels

now=$(date +%s)
last_run=0
[[ -f "$TIME_FILE" ]] && last_run=$(<"$TIME_FILE")

cond_to_emoji() {
    case "$1" in
        *Sunny*|*Clear*) echo "â˜€ï¸" ;;
        *Cloudy*|*Overcast*|*Partly*cloudy*) echo "â˜ï¸" ;;
        *Rain*|*Drizzle*|*Shower*) echo "ðŸŒ§" ;;
        *Snow*|*Sleet*) echo "â„ï¸" ;;
        *Thunder*|*Storm*) echo "â›ˆ" ;;
        *Fog*|*Mist*|*Haze*) echo "ðŸŒ«" ;;
        *) echo "ðŸŒ¤" ;;
    esac
}

fetch_weather() {
    if ! ping -q -c1 1.1.1.1 >/dev/null 2>&1; then
        summary=$(<"$CACHE_FILE" 2>/dev/null || echo "N/A")
        printf '{"text":"%s","tooltip":"Offline"}\n' "$summary"
        return
    fi

    data=$(curl -sf 'http://wttr.in/?format=j1') || {
        summary=$(<"$CACHE_FILE" 2>/dev/null || echo "N/A")
        printf '{"text":"%s","tooltip":"Error fetching"}\n' "$summary"
        return
    }

    today_temp=$(echo "$data" | jq -r '.current_condition[0].temp_C // "N/A"')
    today_cond=$(echo "$data" | jq -r '.current_condition[0].weatherDesc[0].value // "N/A"')
    summary="$(cond_to_emoji "$today_cond")${today_temp}Â°C"
    echo "$summary" > "$CACHE_FILE"

    tooltip=""
    days=$(echo "$data" | jq '.weather | length')
    for i in $(seq 0 $((days-1))); do
        date=$(echo "$data" | jq -r ".weather[$i].date")
        tooltip+="$date "

        for idx in ${!HOURS[@]}; do
            target_hour=${HOURS[$idx]}
            # Find the closest hour in the hourly array
            hour_index=$(echo "$data" | jq -r ".weather[$i].hourly | to_entries | map(.key as \$k | if (.value.time|tonumber) >= $target_hour*100 then \$k else empty end) | first // 0")
            temp=$(echo "$data" | jq -r ".weather[$i].hourly[$hour_index].tempC")
            cond=$(echo "$data" | jq -r ".weather[$i].hourly[$hour_index].weatherDesc[0].value")
            emoji=$(cond_to_emoji "$cond")
            label=${LABELS[$idx]}
            tooltip+="$emoji $label: ${temp}Â°C "
        done

        tooltip+="\n"
    done

    tooltip_escaped=$(echo -n "$tooltip" | sed ':a;N;$!ba;s/\n/\\n/g')
    printf '{"text":"%s","tooltip":"%s"}\n' "$summary" "$tooltip_escaped"
    echo "$now" > "$TIME_FILE"
}

if [[ ! -f "$CACHE_FILE" ]] || (( now - last_run > CACHE_TTL )); then
    fetch_weather
else
    fetch_weather
fi
